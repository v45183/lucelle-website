<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lucelle — Verify Product</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#fff8f0;color:#3a0d0d;margin:0;padding:28px;}
  .wrap{max-width:760px;margin:0 auto}
  .card{background:#fff;border:1px solid #ecd7b8;padding:22px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.06);text-align:center}
  h1{color:#b47d28;margin:4px 0 10px}
  img{max-width:320px;border-radius:10px;border:1px solid #e7c67a}
  .meta{color:#5b3a3a;margin-top:10px}
  .badge{display:inline-block;padding:10px 16px;border-radius:20px;color:#fff;font-weight:700;margin-top:12px}
  .genuine{background:#4CAF50}
  .notfound{background:#F44336;padding:10px 14px;border-radius:8px;color:#fff;font-weight:700}
  .small{font-size:13px;color:#7a5b5b;margin-top:8px}
  .status-text{margin-top:8px;color:#5b3a3a}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <h1>Verifying product...</h1>
      <div id="content" class="small">Please wait — fetching data.</div>
    </div>
  </div>

<script>
/* --- CONFIG: put your sheet ID here --- */
const SHEET_ID = '1TOjNelSG6symhfwmw4qGT1gtvm_BfR05b1jGNq5cFBY';
const SHEET_GID = 0;
const gvizURL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${SHEET_GID}&tqx=out:json`;

const card = document.getElementById('card');
const content = document.getElementById('content');

const params = new URLSearchParams(window.location.search);
const rawId = params.get('id');
if(!rawId){
  content.innerHTML = '<div class="notfound">No product id in URL — add ?id=PRODUCT_ID</div>';
  throw new Error('Missing id');
}
const targetId = rawId.trim();

// helpers
function safe(x, fallback='-'){ return (x === undefined || x === null || x === '') ? fallback : String(x); }
function escapeHtml(s){ return String(s).replace(/[&<>"'`=\/]/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#47;','`':'&#96;','=':'&#61;'}[c]; }); }

// Parse possible GViz date formats like "Date(2026,9,1)" or native strings
function parseGvizDate(value){
  if(!value) return null;
  // If string like Date(YYYY,MM,DD...)
  const m = String(value).match(/Date\((\d+),\s*(\d+),\s*(\d+)/i);
  if(m){
    const year = parseInt(m[1],10);
    const month = parseInt(m[2],10); // GViz month is 0-based? if it shows off-by-one, adjust accordingly
    const day = parseInt(m[3],10);
    // Create date - GViz usually uses 0-based month, but if you see month off-by-one, change month-1
    const dt = new Date(year, month, day);
    return dt;
  }
  // If already a date string
  const d = new Date(value);
  if(!isNaN(d.getTime())) return d;
  return null;
}
function formatDateNice(v){
  const d = parseGvizDate(v);
  if(!d) return safe(v, '-');
  // format like: 01 Sep 2026 or locale
  return d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'2-digit' });
}

// Fetch and render
fetch(gvizURL)
  .then(r => {
    if(!r.ok) throw new Error('Network response ' + r.status + ' ' + r.statusText);
    return r.text();
  })
  .then(text => {
    const jsonText = text.replace(/^[^\(]*\(\s*/, '').replace(/\);\s*$/,'');
    const obj = JSON.parse(jsonText);
    const cols = obj.table.cols.map(c => (c && c.label) ? c.label : '');
    const rows = obj.table.rows || [];
    const data = rows.map(r => {
      const rowObj = {};
      cols.forEach((colLabel, i) => {
        const cell = r.c[i];
        rowObj[colLabel] = cell && cell.v !== undefined ? cell.v : '';
      });
      return rowObj;
    });

    console.log('GViz sample rows:', data.slice(0,6));

    const found = data.find(row => {
      const key = Object.keys(row).find(k => k.toLowerCase().replace(/\s+/g,'') === 'productid');
      if(!key) return false;
      const val = (row[key] || '').toString().trim();
      return val.toLowerCase() === targetId.toLowerCase();
    });

    if(!found){
      content.innerHTML = '<div class="notfound">❌ Product not found or Product ID mismatch.</div>' +
        `<div class="small" style="margin-top:8px">Checked ID: <strong>${escapeHtml(targetId)}</strong></div>` +
        `<div class="small" style="margin-top:6px;color:#9a6b6b">Tip: ensure Product ID exactly matches (no extra spaces).</div>`;
      return;
    }

    // helpers to find columns by name (ignore spaces/case)
    function getRowVal(obj, name){
      const foundKey = Object.keys(obj).find(k => k.toLowerCase().replace(/\s+/g,'') === name.toLowerCase().replace(/\s+/g,''));
      return foundKey ? obj[foundKey] : '';
    }

    const name = safe(getRowVal(found,'Name'), 'Lucelle Product');
    const size = safe(getRowVal(found,'Size'), '-');
    const expiryRaw = getRowVal(found,'Expiry') || getRowVal(found,'Expiration') || '';
    const expiryFormatted = formatDateNice(expiryRaw);
    const batch = safe(getRowVal(found,'Batch'), '-');
    const image = getRowVal(found,'Image') || '';
    const soldVia = safe(getRowVal(found,'Sold Via') || getRowVal(found,'SoldVia') || getRowVal(found,'Sold') || '');
    const status = safe(getRowVal(found,'Status') || '');

    // render
    card.innerHTML = `
      <h1 style="color:#b47d28">${escapeHtml(name)}</h1>
      <div style="margin-top:12px">
        <img src="${image ? escapeHtml(image) : 'https://via.placeholder.com/300x200?text=Lucelle+Product'}"
             alt="${escapeHtml(name)}" onerror="this.src='https://via.placeholder.com/300x200?text=Image+not+found'">
      </div>
      <div class="meta"><strong>Size:</strong> ${escapeHtml(size)} &nbsp; <strong>Expiry:</strong> ${escapeHtml(expiryFormatted)} &nbsp; <strong>Batch:</strong> ${escapeHtml(batch)}</div>
      ${ soldVia ? `<div style="font-style:italic;margin-top:10px;color:#5b3a3a">${escapeHtml(soldVia)}</div>` : '' }
      <div><span class="badge genuine">✅ Genuine</span></div>
      ${ status ? `<div class="status-text">${escapeHtml(status)}</div>` : '' }
      <div class="small" style="margin-top:10px">Product ID: <strong>${escapeHtml(targetId)}</strong></div>
    `;
  })
  .catch(err => {
    console.error(err);
    content.innerHTML = `<div class="notfound">✖ Error loading product data — ${escapeHtml(err.message || err)}</div>`;
  });
</script>
</body>
</html>
